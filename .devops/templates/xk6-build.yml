parameters:
  - name: 'xk6CacheKey'
    type: string
  - name: 'k6Version'
    type: string
    default: v1.3.0
  - name: 'xk6Extensions'
    type: string
    default: '--with github.com/szkiba/xk6-dotenv@v0.2.0'

jobs:
  - job: xk6Build
    displayName: üì¶ Building xk6
    timeoutInMinutes: 0
    steps:
      - task: Cache@2
        inputs:
          key: '$(xk6CacheKey)'
          path: '$(Build.SourcesDirectory)/xk6'
          cacheHitVar: XK6_RESTORED
        displayName: Retrieve xk6 from Cache
      - script: |
          mkdir -p $(Build.SourcesDirectory)/xk6
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$(Build.SourcesDirectory)/xk6:/xk6" \
            grafana/xk6:latest build ${{ parameters.k6Version }} \
            --with github.com/szkiba/xk6-dotenv@v0.2.0 \
            --output /xk6/xk6
        displayName: Build xk6 binary
        condition: ne(variables.XK6_RESTORED, 'true')

      - script: |
          echo "üîç Checking xk6 extensions..."
          ./xk6/xk6 version
          ./xk6/xk6 run --help | grep dotenv && echo "‚úÖ xk6-dotenv present" || echo "‚ùå xk6-dotenv missing"
        displayName: Verify xk6 build